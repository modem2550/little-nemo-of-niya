---
/**
 * GalleryCard.astro
 * - ใช้ SSR เท่านั้น
 * - รองรับ set:html (จำเป็น)
 * - normalize data ภายใน component
 * - performance + CLS friendly
 */

const { event } = Astro.props;

/* ===============================
   Constants
================================ */
const MONTHS = ["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"];

/* ===============================
   Helpers
================================ */
function formatSmartEventDate(dateString) {
  if (!dateString) return '';

  const date = new Date(dateString);
  if (isNaN(date.getTime())) return '';

  const d = String(date.getDate()).padStart(2, '0');
  const m = MONTHS[date.getMonth()];
  const y = date.getFullYear();

  return `${d} ${m} ${y}`;
}

/* ===============================
   Normalize event data
   (ป้องกัน field สะกดไม่ตรง)
================================ */
const normalized = {
  title: event.Event || event.Name || 'Untitled Event',
  photoPage: event['Photo-page'] || event['Phot-page'] || 'By Niya BNK48',
  photoPageLink: event['Photo-page-link'] || '#',
  image:
    event['IMG_link']
      ? `${event['IMG_link']}?quality=60`
      : 'https://via.placeholder.com/400x300?text=No+Image',
  date: formatSmartEventDate(event['Date-At']),
};
---

<div class="col d-flex justify-content-center">
  <div class="img-box tabcontent Event">
    <a
      href={normalized.photoPageLink}
      target="_blank"
      rel="noopener noreferrer"
      aria-label={normalized.title}
    >
      <img
        src={normalized.image}
        alt={normalized.title}
        class="gallery"
        loading="lazy"
        decoding="async"
        width="400"
        height="300"
        onerror="this.onerror=null;this.src='https://via.placeholder.com/400x300?text=Image+Error';"
      />

      <div class="transparent-box">
        <div class="caption mb-0">
          <!-- จำเป็นต้องใช้ set:html -->
          <p>
            <strong set:html={normalized.title} />
          </p>

          <div class="ct-ga">
            <svg class="icon" width="16" height="16" aria-hidden="true">
              <use href="#icon-post"></use>
            </svg>
            <p class="opacity-low mb-0">{normalized.photoPage}</p>
          </div>

          {normalized.date && (
            <div class="ct-ga">
              <svg class="icon" width="16" height="16" aria-hidden="true">
                <use href="#icon-calendar"></use>
              </svg>
              <p>{normalized.date}</p>
            </div>
          )}
        </div>
      </div>
    </a>
  </div>
</div>
