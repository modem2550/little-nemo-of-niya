---
import MainLayout from '../layouts/MainLayout.astro';
import EventCard from '../components/EventCard.astro';
import { getSupabase } from '../lib/supabase.server';

const supabase = getSupabase();
// ดึงข้อมูลจาก Supabase
const { data: events, error } = await supabase
  .from('event_data')
  .select('*')
  // ดึงมาทั้งหมดก่อน แล้วค่อยมา Filter ด้วย Logic ที่ซับซ้อนขึ้นด้านล่าง
  .order('date', { ascending: false });

if (error) {
  console.error('Error fetching events:', error);
}

// ตั้งค่าวันที่ปัจจุบัน (เซ็ตเวลาเป็น 00:00:00 เพื่อให้เปรียบเทียบแค่วันที่)
const today = new Date();
today.setHours(0, 0, 0, 0);

// แยกประเภทงานจากข้อมูลที่ได้มา (events)
const upcomingEvents = events 
  ? events.filter(event => new Date(event.date.replace(/-/g, '/')) >= today).reverse() 
  : [];

const pastEvents = events 
  ? events.filter(event => new Date(event.date.replace(/-/g, '/')) < today) 
  : [];
---

<MainLayout title="Schedule - Niya BNK48's">
    <div style="margin-top: 108px; background: var(--c-primary); padding: 30px 0 30px 0; color: white;" class="mb-3">
        <header>
            <h1 class="text-center fw-800 h1"><strong>Niya BNK48's Schedule</strong></h1>
            <p class="text-center fw-600 mb-0" style="font-size:18px">ตารางงานและกิจกรรมของนีญ่า</p>
        </header>
    </div>
    <main class="page-main">
        <h2 class="h1 text-center fw-800 h-sec mb-0"><strong>Upcoming Events</strong></h2>
        <p class="text-center mb-4 text-muted">กิจกรรมที่กำลังจะจัด</p>
        <section id="upcoming-events-section" style="padding: 0; background: none;">
            <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-4 g-4">
                {upcomingEvents.length > 0 ? (
                    upcomingEvents.map(event => (
                        <div class="col d-flex justify-content-center">
                            <EventCard event={event} />
                        </div>
                    ))
                ) : (
                    <div class="w-100 text-center py-5">
                        <p class="text-muted italic">ยังไม่มีกิจกรรมประกาศในขณะนี้</p>
                    </div>
                )}
            </div>
        </section>

        <div class="text-center mt-5">
            <a class="btn btn-primary btn-rounded fw-600 px-4 mb-5" href="/"> 
                <div class="d-flex align-items-center">
                    <strong>Back Home</strong>
                    <svg class="icon arrow-svg ms-2" width="24" height="24" style="height:1em;width:1em">
                        <use href="#icon-arrow-right"></use>
                    </svg>
                </div>
            </a>
        </div>

        <section id="past-events-section" style="padding: 0; background: none;">
            <h2 class="h-sec h1 text-center mb-0">Past Events</h2>
            <p class="text-center mb-4 text-muted">กิจกรรมที่จัดไปแล้ว</p>
            <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-4 event-past">
                {pastEvents.map(event => (
                    <div class="col d-flex justify-content-center">
                        <EventCard event={event} isPast={true} />
                    </div>
                ))}
            </div>
        </section>
    </main>
</MainLayout>