---
import MainLayout from "../layouts/MainLayout.astro";
import GalleryCard from "../components/GalleryCard.astro";
import { getSupabase } from "../lib/supabase.server";

const supabase = getSupabase();

const { data: allEvents, error } = await supabase
    .from("event_gallery")
    .select(`*`)
    .order("Date-At", { ascending: false });

const allEventsData = allEvents || [];

// ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (Server-side) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ SEO ‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
function groupEventsServer(events: any[]) {
    const grouped: Record<string, any> = {};
    events.forEach((event) => {
        const date = new Date(event["Date-At"]);
        const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, "0")}`;
        const label = date
            .toLocaleString("en-US", { month: "short", year: "numeric" })
            .toUpperCase();

        if (!grouped[key]) grouped[key] = { key, label, events: [] };
        grouped[key].events.push(event);
    });
    return Object.values(grouped).sort((a: any, b: any) =>
        b.key.localeCompare(a.key),
    );
}

const initialGroups = groupEventsServer(allEventsData);
---

<MainLayout title="Gallery - Niya BNK48">
    <div
        style="margin-top: 108px; background: var(--c-primary); padding: 30px 0; color: white;"
        class="mb-3"
    >
        <header>
            <h1 class="text-center fw-800 h1">
                <strong>Niya BNK48's Gallery</strong>
            </h1>
            <p class="text-center fw-600 mb-0" style="font-size:18px">
                ‡∏Ñ‡∏•‡∏±‡∏á‡∏£‡∏π‡∏õ‡∏Ç‡∏≠‡∏á‡∏ô‡∏µ‡∏ç‡πà‡∏≤
            </p>
        </header>
    </div>

    <div class="container-fluid px-3 py-3">
        <div class="row g-3 align-items-center">
            <div class="col-auto">
                <label class="form-label mb-0 fw-600">‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°:</label>
            </div>
            <div class="col-auto">
                <select id="groupBy" class="form-select">
                    <option value="date" selected>Date Update</option>
                    <option value="photo-page">Photographer</option>
                    <option value="event">Event</option>
                </select>
            </div>
            <div class="col-auto ms-auto">
                <span
                    >‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <span id="totalCount">{allEventsData.length}</span> ‡∏£‡∏π‡∏õ</span
                >
            </div>
        </div>
    </div>

    <main class="py-2 px-2">
        <div id="gallery-sections">
            {
                initialGroups.map((group: any) => (
                    <section class="gallery-group mb-5">
                        <div class="group-header d-flex justify-content-between align-items-end mb-3">
                            <h2 class="group-title">{group.label}</h2>
                            <span class="group-title">
                                {group.events.length}
                            </span>
                        </div>
                        <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 row-cols-xl-5 row-cols-xxl-6 g-2 mb-4">
                            {group.events.map((event: any) => (
                                <div class="col">
                                    <GalleryCard event={event} />
                                </div>
                            ))}
                        </div>
                    </section>
                ))
            }
        </div>
    </main>

    <script define:vars={{ allEventsData }}>
    // ========================================
    // Gallery Animation Script - Fixed Version
    // ========================================

    // üîß Global Variables
    const allEvents = allEventsData || [];
    const container = document.getElementById("gallery-sections");
    const select = document.getElementById("groupBy");
    let currentObserver = null;

    // ========================================
    // 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
    // ========================================
    function formatDate(dateStr) {
        if (!dateStr) return "Unknown Date";
        const d = new Date(dateStr);
        const months = [
            "JAN", "FEB", "MAR", "APR", "MAY", "JUN",
            "JUL", "AUG", "SEP", "OCT", "NOV", "DEC",
        ];
        return `${String(d.getDate()).padStart(2, "0")} ${months[d.getMonth()]} ${d.getFullYear()}`;
    }

    // ========================================
    // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Client-side)
    // ========================================
    function groupData(events, criteria) {
        const grouped = {};
        events.forEach((ev) => {
            let key, label;
            if (criteria === "date") {
                const d = new Date(ev["Date-At"]);
                key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}`;
                label = d
                    .toLocaleString("en-US", {
                        month: "short",
                        year: "numeric",
                    })
                    .toUpperCase();
            } else if (criteria === "photo-page") {
                key = label = ev["Photo-page"] || ev["Phot-page"] || "Unknown";
            } else {
                key = label = ev.Event || ev.Name || "Untitled";
            }

            if (!grouped[key])
                grouped[key] = { label, events: [], sortKey: key };
            grouped[key].events.push(ev);
        });

        return Object.values(grouped).sort((a, b) =>
            criteria === "date"
                ? b.sortKey.localeCompare(a.sortKey)
                : a.label.localeCompare(b.label, "th"),
        );
    }

    // ========================================
    // 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏¥‡∏î‡∏°‡πà‡∏≤‡∏ô (Close Animation)
    // ========================================
    function closeAllItems() {
        return new Promise((resolve) => {
            const boxes = document.querySelectorAll(".img-box");
            const headers = document.querySelectorAll(".group-header");
            
            // ‡∏õ‡∏¥‡∏î‡∏ó‡∏±‡πâ‡∏á img-box ‡πÅ‡∏•‡∏∞ group-header
            boxes.forEach(box => {
                box.classList.remove("is-loaded");
                box.classList.add("is-closing");
            });
            
            headers.forEach(header => {
                header.classList.remove("is-loaded");
                header.classList.add("is-closing");
            });
            
            // ‡∏£‡∏≠‡πÉ‡∏´‡πâ animation ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à (800ms)
            setTimeout(resolve, 800);
        });
    }

    // ========================================
    // 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏°‡πà‡∏≤‡∏ô Animation
    // ========================================
    function revealImages() {
        // üîß ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î observer ‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô
        if (currentObserver) {
            currentObserver.disconnect();
            currentObserver = null;
        }

        const boxes = document.querySelectorAll(".img-box:not(.is-loaded)");
        const headers = document.querySelectorAll(".group-header:not(.is-loaded)");
        
        console.log(`üé¨ Starting reveal: ${boxes.length} boxes, ${headers.length} headers`);

        // üéØ ‡πÄ‡∏õ‡∏¥‡∏î group-header ‡∏Å‡πà‡∏≠‡∏ô
        headers.forEach((header, index) => {
            setTimeout(() => {
                requestAnimationFrame(() => {
                    header.classList.remove("is-closing");
                    header.classList.add("is-loaded");
                });
            }, index * 50);
        });

        // üñºÔ∏è ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ boxes ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏•‡∏¢ return
        if (boxes.length === 0) {
            console.log('‚ö†Ô∏è No boxes to reveal');
            return;
        }

        // üñºÔ∏è ‡πÄ‡∏õ‡∏¥‡∏î img-box
        const observedBoxes = new Set();

        const observer = new IntersectionObserver(
            (entries) => {
                entries.forEach((entry) => {
                    if (entry.isIntersecting && !observedBoxes.has(entry.target)) {
                        const box = entry.target;
                        const img = box.querySelector("img");
                        
                        observedBoxes.add(box);

                        const startRevealAnimation = () => {
                            // ‡∏™‡∏∏‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 0-1000ms
                            const randomDelay = Math.random() * 0;

                            setTimeout(() => {
                                requestAnimationFrame(() => {
                                    box.classList.remove("is-closing");
                                    box.classList.add("is-loaded");
                                    console.log('‚úÖ Box revealed');
                                });
                            }, randomDelay);
                        };

                        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏£‡∏π‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
                        if (img && img.complete && img.naturalHeight !== 0) {
                            console.log('üñºÔ∏è Image already loaded');
                            startRevealAnimation();
                        } else if (img) {
                            console.log('‚è≥ Waiting for image load');
                            img.addEventListener("load", startRevealAnimation, { once: true });
                            img.addEventListener("error", () => {
                                console.log('‚ùå Image load error');
                                requestAnimationFrame(() => {
                                    box.classList.remove("is-closing");
                                    box.classList.add("is-loaded");
                                });
                            }, { once: true });

                            // üîß Fallback: ‡∏ñ‡πâ‡∏≤‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà trigger load (lazy/observer ‡πÑ‡∏°‡πà‡∏¢‡∏¥‡∏á)
                            setTimeout(() => {
                                if (!box.classList.contains("is-loaded")) {
                                    startRevealAnimation();
                                }
                            }, 1200);
                        } else {
                            // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ ‡∏Å‡πá‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏•‡∏¢
                            console.log('‚ö†Ô∏è No image found, revealing anyway');
                            startRevealAnimation();
                        }

                        observer.unobserve(box);
                    }
                });
            },
            { 
                threshold: 0.1,
                rootMargin: "50px"
            }
        );

        // üîß ‡πÄ‡∏Å‡πá‡∏ö reference ‡∏Ç‡∏≠‡∏á observer
        currentObserver = observer;

        boxes.forEach((box) => {
            observer.observe(box);
        });

        // üîß Safety net: ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏•‡∏±‡∏á render ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        setTimeout(() => {
            document.querySelectorAll(".img-box:not(.is-loaded)").forEach((box) => {
                box.classList.remove("is-closing");
                box.classList.add("is-loaded");
            });
        }, 1500);
    }

    // ========================================
    // 5. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î Gallery ‡πÉ‡∏´‡∏°‡πà (‡∏û‡∏£‡πâ‡∏≠‡∏° Close-Open Animation)
    // ========================================
    async function render() {
        console.log('üîÑ Render function called');
        
        // 1. ‡∏õ‡∏¥‡∏î‡∏°‡πà‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô
        await closeAllItems();
        
        // 2. ‡∏ß‡∏≤‡∏î HTML ‡πÉ‡∏´‡∏°‡πà
        const criteria = select.value;
        const groups = groupData(allEvents, criteria);

        container.innerHTML = groups
            .map(
                (g) => `
            <section class="gallery-group mb-5">
                <div class="group-header d-flex justify-content-between align-items-end mb-3">
                    <h2 class="group-title">${g.label}</h2>
                    <span class="group-title" style="color: var(--c-content);">${g.events.length}</span>
                </div>
                <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 row-cols-xl-5 row-cols-xxl-6 g-2 mb-4">
                    ${g.events
                        .map(
                            (ev) => `
                        <div class="col">
                            <div class="img-box">
                                <a href="${ev["Photo-page-link"] || "#"}" target="_blank">
                                    <img src="${ev["IMG_link"] || ev["Cover-Image"]}" alt="${ev.Event || ev.Name || "Event"}" loading="lazy">
                                    <div class="transparent-box"></div>
                                    <div class="caption">
                                        <p><strong>${ev.Event || ev.Name || "Event"}</strong></p>
                                        <div class="ct-ga">
                                            <svg class="icon" width="16" height="16"><use href="#icon-post"></use></svg>
                                            <p class="opacity-low mb-0">${ev["Photo-page"] || ev["Phot-page"] || "Unknown"}</p>
                                        </div>
                                        <div class="ct-ga">
                                            <svg class="icon" width="16" height="16"><use href="#icon-calendar"></use></svg>
                                            <p class="mb-0">${formatDate(ev["Date-At"])}</p>
                                        </div>
                                    </div>
                                    <p><strong>${ev.Event || ev.Name || "Event"}</strong></p>
                                </a>
                            </div>
                        </div>
                    `,
                        )
                        .join("")}
                </div>
            </section>
            `,
            )
            .join("");

        console.log('üìù HTML rendered, now revealing...');

        // 3. ‡πÄ‡∏õ‡∏¥‡∏î‡∏°‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
        requestAnimationFrame(() => {
            revealImages();
        });
    }

    // ========================================
    // 6. Event Listeners & Initialization
    // ========================================
    
    // Event Listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Select
    select.addEventListener("change", render);
    
    // üî• FIX: ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠ script ‡πÇ‡∏´‡∏•‡∏î
    console.log('üöÄ Initializing gallery...');
    
    // ‡πÉ‡∏ä‡πâ setTimeout ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ DOM ‡∏û‡∏£‡πâ‡∏≠‡∏°
    setTimeout(() => {
        revealImages();
    }, 100);
</script>
</MainLayout>
