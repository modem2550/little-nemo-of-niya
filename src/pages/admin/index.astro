---
import { supabaseAdmin } from '../../lib/supabaseAdmin';
import "../../styles/main.css";

//const auth = Astro.request.headers.get("authorization");

//if (auth !== `Bearer ${import.meta.env.ADMIN_TOKEN}`) {
//  return new Response("Unauthorized", { status: 401 });
//}
const { data: events, error } = await supabaseAdmin
    .from('event_data')
    .select('*')
    .order('date', { ascending: false });

if (Astro.request.method === "POST") {
    const formData = await Astro.request.formData();
    const id = formData.get("id");
    await supabaseAdmin.from('event_data').delete().eq('id', id);
    return Astro.redirect('/admin'); // Refresh หน้า
} else if (error) {
    console.error('Error fetching events:', error);
}
---

<meta charset="UTF-8" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<div class="container">

    <section>
        <h1>Event Management</h1>
        <a href="/admin/create">เพิ่มกิจกรรมใหม่</a>
        <table>
            <thead>
                <tr>
                <th>Title</th>
                <th>Date</th>
                <th>End Date</th>
                <th>Location (option)</th>
                <th>Link</th>
                <th>Image URL</th>
                <th>Live</th>
                </tr>
            </thead>
            <tbody>
                {events?.map((event) => (
                <tr>
                    <td>{event.title}</td>
                    <td>{event.date}</td>
                    <td>{event.end_date}</td>
                    <td>{event.location}</td>
                    <td>{event.link}</td>
                    <td>{event.image_url}</td>
                    <td>{event.live}</td>
                    <td>
                    <a href={`/admin/edit/${event.id}`}>แก้ไข</a>
                    <form method="POST" style="display:inline;">
                        <input type="hidden" name="id" value={event.id} />
                        <button type="submit" onclick="return confirm('ยืนยันการลบ?')">ลบ</button>
                    </form>
                    </td>
                </tr>
                ))}
            </tbody>
        </table>
    </section>  
</div>

<style>
    body {
        overflow: scroll;
    }

    section {
        background-color: none;
    }
</style>