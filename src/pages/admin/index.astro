---
import { supabaseAdmin } from "../../lib/supabaseAdmin";
import "../../styles/main.css";

const { data: events, error } = await supabaseAdmin
  .from("event_data")
  .select("*")
  .order("date", { ascending: false });

if (error) console.error(error);
---

<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Event Management - Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <div class="container py-4">
    <h1>Event Management</h1>
    <a href="/admin/create" class="btn btn-success mb-3">เพิ่มกิจกรรมใหม่</a>

    {events && events.length > 0 ? (
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>Title</th>
            <th>Date</th>
            <th>End Date</th>
            <th>Location</th>
            <th>Link</th>
            <th>Image</th>
            <th>Live</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {events.map((event) => (
            <tr>
              <td>{event.title}</td>
              <td>{event.date}</td>
              <td>{event.end_date}</td>
              <td>{event.location}</td>
              <td><a href={event.link} target="_blank" rel="noopener noreferrer">{event.link}</a></td>
              <td>
                {event.image_url && (
                  <img src={event.image_url} alt={event.title} style="max-width: 100px; height: auto;" />
                )}
              </td>
              <td>{event.live ? '✅' : '❌'}</td>
              <td>
                <a href={`/admin/edit/${event.id}`} class="btn btn-primary btn-sm">แก้ไข</a>
                <button class="btn btn-danger btn-sm delete-btn" data-event-id={event.id}>ลบ</button>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    ) : (
      <div class="alert alert-info">ยังไม่มีกิจกรรม</div>
    )}
  </div>

  <script>
    async function deleteEvent(id: string) {
      if (!confirm('แน่ใจว่าต้องการลบกิจกรรมนี้?')) return;
      
      try {
        const response = await fetch('/api/admin-event-delete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: parseInt(id) }) // แปลง string เป็น number
        });
        
        const result = await response.json();
        
        if (response.ok) {
          alert('ลบสำเร็จ!');
          window.location.reload();
        } else {
          alert(`เกิดข้อผิดพลาด: ${result.error || 'Unknown error'}`);
        }
      } catch (error) {
        console.error('Error:', error);
        alert('เกิดข้อผิดพลาดในการเชื่อมต่อ');
      }
    }

    // เพิ่ม event listeners ให้กับปุ่มทั้งหมด
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.delete-btn').forEach(button => {
        button.addEventListener('click', () => {
          const eventId = (button as HTMLButtonElement).dataset.eventId;
          if (eventId) {
            deleteEvent(eventId);
          }
        });
      });
    });
  </script>
</body>
</html>