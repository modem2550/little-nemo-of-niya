---
import { supabaseAdmin } from "../../lib/supabaseAdmin";
import "../../styles/main.css";
import "../../styles/admin.css";

const { data: events, error } = await supabaseAdmin
  .from("event_data")
  .select("*")
  .order("date", { ascending: false });

if (error) console.error(error);
---

<!doctype html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@100..900&family=Noto+Sans+Thai:wght@100..900&display=swap" rel="stylesheet">
    <title>Event Management - Admin</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"/>

  </head>
  <body>
    <div>
      <div class="header">
        <h1 class="display-2">Event Management System</h1>
      </div>
      <div class="header-actions">
          <a href="/admin/create" class="btn-create">
            <span>➕</span>
            <span>เพิ่มกิจกรรมใหม่</span>
          </a>
          <a href="/" class="btn-create">
            <span>กลับหน้าหลัก</span>
          </a>
        </div>
      {events && events.length > 0 && (
        <div class="stats-grid">
          <div class="stat-card">
            <h3>{events.length}</h3>
            <p>กิจกรรมทั้งหมด</p>
          </div>
          <div class="stat-card">
            <h3>{events.filter(e => new Date(e.date) >= new Date()).length}</h3>
            <p>กิจกรรมที่กำลังจะมาถึง</p>
          </div>
        </div>
      )}
    </div>
    <div>
      <div class="table-container">
        <div class="table-header">
          <h2>รายการกิจกรรมทั้งหมด</h2>
        </div>

        {events && events.length > 0 ? (
          <div style="overflow-x: auto;">
            <table class="table">
              <thead>
                <tr>
                  <th>รูปภาพ</th>
                  <th>ชื่อกิจกรรม</th>
                  <th>วันที่</th>
                  <th>วันที่สิ้นสุด</th>
                  <th>สถานที่</th>
                  <th>ลิงก์</th>
                  <th>สถานะ</th>
                  <th>จัดการ</th>
                </tr>
              </thead>
              <tbody>
                {events.map((event) => (
                  <tr>
                    <td>
                      {event.image_urls?.thumbnail ? (
                        <img
                          src={event.image_urls.thumbnail}
                          alt={event.title}
                          class="event-thumb"
                          loading="lazy"
                        />
                      ) : (
                        <div class="no-image">No Image</div>
                      )}
                    </td>
                    <td>
                      <div class="event-title">{event.title}</div>
                    </td>
                    <td>
                      <div class="event-date">{event.date}</div>
                    </td>
                    <td>
                      <div class="event-date">{event.end_date || '-'}</div>
                    </td>
                    <td>{event.location || '-'}</td>
                    <td>
                      {event.link ? (
                        <a 
                          href={event.link} 
                          target="_blank" 
                          rel="noopener"
                          style="color: var(--c-primary); font-weight: 600;"
                        >
                         ดูลิงก์
                        </a>
                      ) : (
                        <span class="text-muted">-</span>
                      )}
                    </td>
                    <td>
                      {event.live ? (
                        <span class="badge-live">{event.live}</span>
                      ) : (
                        <span class="text-muted">-</span>
                      )}
                    </td>
                    <td>
                      <div class="action-buttons">
                        <a
                          href={`/admin/edit/${event.id}`}
                          class="btn-edit"
                        >
                          แก้ไข
                        </a>
                        <button
                          class="btn-delete delete-btn"
                          data-event-id={event.id}
                        >
                          ลบ
                        </button>
                      </div>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        ) : (
          <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
            </svg>
            <h3>ยังไม่มีกิจกรรม</h3>
            <p>เริ่มต้นโดยการเพิ่มกิจกรรมใหม่</p>
          </div>
        )}
      </div>
    </div>

    <script>
      async function deleteEvent(id: string) {
        if (!confirm("แน่ใจว่าต้องการลบกิจกรรมนี้?")) return;

        const button = document.querySelector(`[data-event-id="${id}"]`) as HTMLButtonElement;
        const originalText = button.innerHTML;
        
        // Show loading
        button.disabled = true;
        button.innerHTML = '<span class="spinner"></span> กำลังลบ...';

        try {
          const response = await fetch("/api/admin-event-delete", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id: parseInt(id) }),
          });

          if (response.ok) {
            button.innerHTML = '✓ ลบสำเร็จ';
            setTimeout(() => {
              window.location.reload();
            }, 500);
          } else {
            const result = await response.json();
            alert("เกิดข้อผิดพลาด: " + (result.error || "Unknown error"));
            button.disabled = false;
            button.innerHTML = originalText;
          }
        } catch (error) {
          console.error("Error:", error);
          alert("เกิดข้อผิดพลาดในการเชื่อมต่อ");
          button.disabled = false;
          button.innerHTML = originalText;
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        const deleteButtons = document.querySelectorAll<HTMLButtonElement>(".delete-btn");

        deleteButtons.forEach((button) => {
          button.addEventListener("click", async () => {
            const eventId = button.dataset.eventId;
            if (eventId) {
              await deleteEvent(eventId);
            }
          });
        });
      });
    </script>
  </body>
</html>