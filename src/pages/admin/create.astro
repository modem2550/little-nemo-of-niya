---
import "../../styles/main.css";
import "../../styles/admin.css";
---

<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@100..900&family=Noto+Sans+Thai:wght@100..900&display=swap" rel="stylesheet">
  <title>เพิ่มกิจกรรมใหม่ - Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <div>
    <div class="create-card">
      <!-- Header -->
      <div class="header">
        <h1 class="display-2">Create Event</h1>
      </div>

      <!-- Form Body -->
      <div class="create-body">
        <form id="eventForm">
          
          <!-- ข้อมูลพื้นฐาน -->
          <div class="form-section">
            <div class="section-title">ข้อมูลพื้นฐาน</div>
            
            <div class="mb-3">
              <label for="title" class="form-label required">ชื่อกิจกรรม</label>
              <input 
                type="text" 
                class="form-control" 
                id="title" 
                required
                placeholder="เช่น BNK48 Concert 2026"
              />
              <div class="invalid-feedback">กรุณากรอกชื่อกิจกรรม</div>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="date" class="form-label required">วันที่เริ่ม</label>
                <input 
                  type="date" 
                  class="form-control" 
                  id="date" 
                  required
                />
                <div class="invalid-feedback">กรุณาเลือกวันที่</div>
              </div>
              <div class="col-md-6 mb-3">
                <label for="end_date" class="form-label">วันที่สิ้นสุด</label>
                <input 
                  type="date" 
                  class="form-control" 
                  id="end_date"
                />
                <small class="helper-text">ไม่ต้องกรอกถ้าจบในวันเดียว</small>
              </div>
            </div>
          </div>

          <!-- สถานที่และลิงก์ -->
          <div class="form-section">
            <div class="section-title">
              <span>สถานที่และลิงก์</span>
            </div>
            
            <div class="mb-3">
              <label for="location" class="form-label">สถานที่</label>
              <input 
                type="text" 
                class="form-control" 
                id="location"
                placeholder="เช่น MBK Center, Avenue A G Floor"
              />
            </div>

            <div class="mb-3">
              <label for="link" class="form-label">ลิงก์กิจกรรม</label>
              <input 
                type="url" 
                class="form-control" 
                id="link"
                placeholder="https://..."
              />
            </div>

            <div class="mb-3">
              <label for="live" class="form-label">ช่องไลฟ์ / สถานะ</label>
              <input 
                type="text" 
                class="form-control" 
                id="live"
                placeholder="เช่น YouTube Live, Upcoming, Completed"
              />
            </div>
          </div>

          <!-- รูปภาพ -->
          <div class="form-section">
            <div class="section-title">
              <span>รูปภาพกิจกรรม</span>
            </div>
            
            <div class="mb-3">
              <label for="imageFile" class="form-label required">เลือกรูปภาพ</label>
              <input 
                type="file" 
                class="form-control" 
                id="imageFile" 
                accept="image/*" 
                required
              />
              <div class="invalid-feedback">กรุณาเลือกรูปภาพ</div>
              <small class="helper-text">
                รองรับ: JPG, PNG, GIF (สูงสุด 10MB) • จะถูก optimize อัตโนมัติเป็น 4 ขนาด (Thumbnail, Small, Medium, Large)
              </small>
            </div>

            <!-- Progress Section -->
            <div id="progressSection" class="progress-section">
              <h6 class="mb-3">
                <span class="spinner-border spinner-border-sm"></span>
                <span>กำลังประมวลผลรูปภาพ...</span>
              </h6>
              
              <div class="size-progress">
                <label class="form-label">Thumbnail (150px - สำหรับตัวอย่าง)</label>
                <div class="progress">
                  <div id="progress-thumbnail" class="progress-bar" role="progressbar">0%</div>
                </div>
              </div>

              <div class="size-progress">
                <label class="form-label">Small (640px - มือถือ)</label>
                <div class="progress">
                  <div id="progress-small" class="progress-bar" role="progressbar">0%</div>
                </div>
              </div>

              <div class="size-progress">
                <label class="form-label">Medium (1024px - แท็บเล็ต)</label>
                <div class="progress">
                  <div id="progress-medium" class="progress-bar" role="progressbar">0%</div>
                </div>
              </div>

              <div class="size-progress">
                <label class="form-label">Large (1920px - Desktop)</label>
                <div class="progress">
                  <div id="progress-large" class="progress-bar" role="progressbar">0%</div>
                </div>
              </div>
            </div>

            <!-- Preview Grid -->
            <div id="previewGrid" class="preview-grid"></div>
          </div>

          <!-- Upload Status -->
          <div id="uploadSection" class="upload-section">
            <div class="d-flex align-items-center">
              <span class="spinner-border spinner-border-sm me-2"></span>
              <span id="uploadStatus">กำลังอัปโหลดรูปภาพ...</span>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="action-buttons">
            <a href="/admin" class="btn-cancel">
              ← ยกเลิก
            </a>
            <button type="submit" class="btn-submit" id="submitBtn">
              <span id="submitText">บันทึกกิจกรรม</span>
              <span id="submitSpinner" class="spinner-border spinner-border-sm ms-2" style="display: none;"></span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    import imageCompression from 'browser-image-compression';
    import { 
      generateResponsiveImages, 
      validateImageFile, 
      formatFileSize 
    } from '../../lib/imageOptimizer';

    const form = document.getElementById('eventForm') as HTMLFormElement;
    const imageFile = document.getElementById('imageFile') as HTMLInputElement;
    const progressSection = document.getElementById('progressSection') as HTMLElement;
    const previewGrid = document.getElementById('previewGrid') as HTMLElement;
    const uploadSection = document.getElementById('uploadSection') as HTMLElement;
    const uploadStatus = document.getElementById('uploadStatus') as HTMLElement;
    const submitBtn = document.getElementById('submitBtn') as HTMLButtonElement;
    const submitText = document.getElementById('submitText') as HTMLElement;
    const submitSpinner = document.getElementById('submitSpinner') as HTMLElement;

    let generatedImages: any = null;

    // Handle image selection
    imageFile.addEventListener('change', async (e) => {
      const target = e.target as HTMLInputElement;
      const file = target.files?.[0];
      
      if (!file) return;

      // Validate file
      const validation = validateImageFile(file);
      if (!validation.valid) {
        alert(validation.error);
        imageFile.value = '';
        return;
      }

      try {
        // Show progress section
        progressSection.classList.add('active');
        previewGrid.innerHTML = '';
        previewGrid.style.display = 'none';

        // Generate responsive images
        generatedImages = await generateResponsiveImages(file, (progress) => {
          const sizeKey = progress.size.split(' ')[0].toLowerCase();
          updateProgress(sizeKey, progress.progress);
        });

        // Show previews
        previewGrid.style.display = 'grid';
        for (const [size, imgFile] of Object.entries(generatedImages)) {
          const url = URL.createObjectURL(imgFile as File);
          const fileSize = formatFileSize((imgFile as File).size);
          
          const sizeLabels: Record<string, string> = {
            thumbnail: 'Thumbnail',
            small: 'Small',
            medium: 'Medium',
            large: 'Large'
          };
          
          const previewItem = document.createElement('div');
          previewItem.className = 'preview-item';
          previewItem.innerHTML = `
            <img src="${url}" alt="${size}" loading="lazy">
            <strong>${sizeLabels[size]}</strong>
            <span class="badge">${fileSize}</span>
          `;
          previewGrid.appendChild(previewItem);
        }

        progressSection.classList.remove('active');

      } catch (error: any) {
        console.error('Error:', error);
        alert('เกิดข้อผิดพลาดในการประมวลผลรูปภาพ');
        imageFile.value = '';
        progressSection.classList.remove('active');
      }
    });

    function updateProgress(size: string, percent: number) {
      const progressBar = document.getElementById(`progress-${size}`);
      if (progressBar) {
        progressBar.style.width = `${percent}%`;
        progressBar.textContent = `${Math.round(percent)}%`;
      }
    }

    // Handle form submit
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!form.checkValidity()) {
        form.classList.add('was-validated');
        return;
      }

      if (!generatedImages) {
        alert('กรุณาเลือกรูปภาพ');
        return;
      }

      try {
        // Disable submit button
        submitBtn.disabled = true;
        submitText.textContent = 'กำลังบันทึก...';
        submitSpinner.style.display = 'inline-block';

        // Show upload section
        uploadSection.classList.add('active');
        uploadStatus.textContent = 'กำลังอัปโหลดรูปภาพไป Supabase...';

        // Generate unique event ID
        const eventId = `event-${Date.now()}`;

        // Upload images via API
        const formData = new FormData();
        formData.append('eventId', eventId);
        
        for (const [size, file] of Object.entries(generatedImages)) {
          formData.append(size, file as File);
        }

        const uploadResponse = await fetch('/api/upload-images', {
          method: 'POST',
          body: formData
        });

        if (!uploadResponse.ok) {
          const error = await uploadResponse.json();
          throw new Error(error.error || 'Upload failed');
        }

        const { urls: imageUrls } = await uploadResponse.json();

        uploadStatus.textContent = 'กำลังบันทึกข้อมูลลง Database...';

        // Prepare event data
        const eventData = {
          title: (document.getElementById('title') as HTMLInputElement).value,
          date: (document.getElementById('date') as HTMLInputElement).value,
          end_date: (document.getElementById('end_date') as HTMLInputElement).value || null,
          location: (document.getElementById('location') as HTMLInputElement).value || null,
          link: (document.getElementById('link') as HTMLInputElement).value || null,
          live: (document.getElementById('live') as HTMLInputElement).value || null,
          image_urls: imageUrls,
        };

        // Submit to API
        const response = await fetch('/api/admin-event-create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(eventData)
        });

        if (!response.ok) {
          const result = await response.json();
          throw new Error(result.error || 'เกิดข้อผิดพลาด');
        }

        // Success!
        uploadStatus.textContent = '✓ บันทึกสำเร็จ! กำลังกลับหน้าแรก...';
        
        setTimeout(() => {
          window.location.href = '/admin';
        }, 1000);

      } catch (error: any) {
        console.error('Error:', error);
        alert(`เกิดข้อผิดพลาด: ${error.message}`);
        
        submitBtn.disabled = false;
        submitText.textContent = 'บันทึกกิจกรรม';
        submitSpinner.style.display = 'none';
        uploadSection.classList.remove('active');
      }
    });
  </script>
</body>
</html>