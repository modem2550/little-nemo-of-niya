---
export const prerender = false;

import { supabaseAdmin } from "../../../lib/supabaseAdmin";
import "../../../styles/main.css";

const { id } = Astro.params;

// ===== GET =====
const { data: event, error: fetchError } = await supabaseAdmin
  .from("event_data")
  .select("*")
  .eq("id", Number(id))
  .single();

if (fetchError || !event) {
  return new Response("Not found", { status: 404 });
}

// ===== POST =====
if (Astro.request.method === "POST") {
  const form = await Astro.request.formData();

  const date = form.get("date") || null;
  const end_date = form.get("end_date") || null;
  const live = form.get("live") === "on"; // checkbox

  if (date && end_date && end_date < date) {
    return new Response("end_date ห้ามน้อยกว่า date", { status: 400 });
  }

  const payload = {
  title: form.get("title"),
  date: form.get("date") || null,
  end_date: form.get("end_date") || null,
  location: form.get("location"),
  link: form.get("link"),
  image_url: form.get("image_url"),
  live: form.get("live") || null, // text
};

const { data, error } = await supabaseAdmin
  .from("event_data")
  .update(payload)
  .eq("id", Number(id))
  .select();

console.log(data, error);
  if (error) {
    return new Response(
      JSON.stringify(error, null, 2),
      { status: 500 }
    );
  }

  return Astro.redirect("/admin");
}
---

<meta charset="UTF-8" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<div class="container">
  <form id="editForm">
    <input type="hidden" name="id" value={event.id} />
    <p>ชื่อกิจกรรม </p>
    <input name="title" value={event.title} />
    <p>วันที่ </p>
    <input type="date" id="date" name="date" value={event.date} />
    <p>ถึงวันที่ </p>
    <input type="date" id="end_date" name="end_date" value={event.end_date} />
    <p>สถานที่ </p>
    <input name="location" value={event.location} />
    <p>ลิงก์ </p>
    <input name="link" value={event.link} />
    <p>รูปภาพ </p>
    <input name="image_url" value={event.image_url} />
    <p>ช่องไลฟ์ </p>
    <input name="live" value={event.live} />

    <button type="submit" class="btn btn-primary">บันทึก</button>
  </form>
</div>

<script>
  const form = document.getElementById("editForm") as HTMLFormElement;

form.addEventListener("submit", async (e) => {
  e.preventDefault();

  const data = new FormData(form);

  try {
    const res = await fetch("/api/admin-event-edit", {
      method: "POST",
      body: data
    });

    if (res.ok) {
      alert("แก้ไขเรียบร้อย!");
      window.location.href = "/admin";
    } else {
      const text = await res.text();
      alert("เกิดข้อผิดพลาด: " + text);
    }
  } catch (err) {
    console.error(err);
    alert("เกิดข้อผิดพลาดเครือข่าย");
  }
});


const startDate = document.getElementById('date') as HTMLInputElement;
const endDate = document.getElementById('end_date') as HTMLInputElement;

  if (startDate && endDate) {
    startDate.addEventListener("change", () => {
      endDate.min = startDate.value;
      if (endDate.value && endDate.value < startDate.value) {
        endDate.value = "";
      }
    });
  }
</script>
