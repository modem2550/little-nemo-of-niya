---
export const prerender = false;

import { supabaseAdmin } from "../../../lib/supabaseAdmin";
import "../../../styles/main.css";
import "../../../styles/admin.css";

const { id } = Astro.params;

// ===== GET =====
const { data: event, error: fetchError } = await supabaseAdmin
  .from("event_data")
  .select("*")
  .eq("id", Number(id))
  .single();

if (fetchError || !event) {
  return new Response("Not found", { status: 404 });
}
---

<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@100..900&family=Noto+Sans+Thai:wght@100..900&display=swap" rel="stylesheet">
  <title>แก้ไขกิจกรรม - Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <div>
    <div class="create-card">
      <!-- Header -->
      <div class="header">
        <h1 class="display-2">Edit Event</h1>
      </div>

      <!-- Form Body -->
      <div class="create-body">
        <form id="editForm">
          <input type="hidden" name="id" value={event.id} />

          <!-- ข้อมูลหลัก -->
          <div class="form-section">
            <div class="section-title">ข้อมูลพื้นฐาน</div>
            
            <div class="mb-3">
              <label for="title" class="form-label required">ชื่อกิจกรรม</label>
              <input 
                type="text" 
                class="form-control" 
                id="title" 
                name="title" 
                value={event.title} 
                required
                placeholder="เช่น BNK48 Concert 2026"
              />
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="date" class="form-label required">วันที่เริ่ม</label>
                <input 
                  type="date" 
                  class="form-control" 
                  id="date" 
                  name="date" 
                  value={event.date} 
                  required
                />
              </div>
              <div class="col-md-6 mb-3">
                <label for="end_date" class="form-label">วันที่สิ้นสุด</label>
                <input 
                  type="date" 
                  class="form-control" 
                  id="end_date" 
                  name="end_date" 
                  value={event.end_date || ''} 
                />
                <small class="helper-text">ไม่ต้องกรอกถ้าจบในวันเดียว</small>
              </div>
            </div>
          </div>

          <!-- สถานที่และลิงก์ -->
          <div class="form-section">
            <div class="section-title">สถานที่และลิงก์</div>
            
            <div class="mb-3">
              <label for="location" class="form-label">สถานที่</label>
              <input 
                type="text" 
                class="form-control" 
                id="location" 
                name="location" 
                value={event.location || ''} 
                placeholder="เช่น MBK Center, Avenue A G Floor"
              />
            </div>

            <div class="mb-3">
              <label for="link" class="form-label required">ลิงก์กิจกรรม</label>
              <input 
                type="url" 
                class="form-control" 
                id="link" 
                name="link" 
                value={event.link} 
                required
                placeholder="https://..."/>
            </div>
            <div class="mb-3">
              <label for="live" class="form-label">ช่องไลฟ์ / สถานะ</label>
              <input 
                type="text" 
                class="form-control" 
                id="live" 
                name="live" 
                value={event.live || ''} 
                placeholder="เช่น YouTube Live, Facebook Live, TikTok Live"
              />
            </div>
          </div>

          <!-- รูปภาพ -->
          <div class="form-section">
            <div class="section-title">รูปภาพกิจกรรม</div>
            
            <!-- แสดงรูปเก่า (ถ้ามี) -->
            {(event.image_url || event.image_urls) && (
              <div class="mb-3">
                <label class="form-label">รูปภาพปัจจุบัน</label>
                <div class="current-image-preview">
                  {event.image_urls ? (
                    <img 
                      src={event.image_urls.medium || event.image_urls.small || event.image_urls.large} 
                      alt="Current event image" 
                      style="max-width: 300px; border-radius: 8px;"
                    />
                  ) : event.image_url ? (
                    <img 
                      src={event.image_url} 
                      alt="Current event image" 
                      style="max-width: 300px; border-radius: 8px;"
                    />
                  ) : null}
                </div>
                <small class="helper-text">อัปโหลดรูปใหม่ด้านล่างเพื่อแทนที่</small>
              </div>
            )}

            <div class="mb-3">
              <label for="imageFile" class="form-label">เลือกรูปภาพใหม่ (ถ้าต้องการเปลี่ยน)</label>
              <input 
                type="file" 
                class="form-control" 
                id="imageFile" 
                accept="image/*"
              />
              <small class="helper-text">
                รองรับ: JPG, PNG, GIF (สูงสุด 10MB) • จะถูก optimize อัตโนมัติเป็น 4 ขนาด
              </small>
            </div>

            <!-- Progress Section -->
            <div id="progressSection" class="progress-section">
              <h6 class="mb-3">
                <span class="spinner-border spinner-border-sm"></span>
                <span>กำลังประมวลผลรูปภาพ...</span>
              </h6>
              
              <div class="size-progress">
                <label class="form-label">Thumbnail (150px)</label>
                <div class="progress">
                  <div id="progress-thumbnail" class="progress-bar" role="progressbar">0%</div>
                </div>
              </div>

              <div class="size-progress">
                <label class="form-label">Small (640px)</label>
                <div class="progress">
                  <div id="progress-small" class="progress-bar" role="progressbar">0%</div>
                </div>
              </div>

              <div class="size-progress">
                <label class="form-label">Medium (1024px)</label>
                <div class="progress">
                  <div id="progress-medium" class="progress-bar" role="progressbar">0%</div>
                </div>
              </div>

              <div class="size-progress">
                <label class="form-label">Large (1920px)</label>
                <div class="progress">
                  <div id="progress-large" class="progress-bar" role="progressbar">0%</div>
                </div>
              </div>
            </div>

            <!-- Preview Grid -->
            <div id="previewGrid" class="preview-grid"></div>
          </div>

          <!-- Upload Status -->
          <div id="uploadSection" class="upload-section">
            <div class="d-flex align-items-center">
              <span class="spinner-border spinner-border-sm me-2"></span>
              <span id="uploadStatus">กำลังประมวลผล...</span>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="row">
            <div class="col-12 col-lg-6 mb-3">
              <a href="/admin" class="btn-cancel">← ยกเลิก</a>
            </div>
            <div class="col-12 col-lg-6 mb-3">
              <button type="submit" id="submitBtn" class="btn-submit">
                <span id="submitText">บันทึกการแก้ไข</span>
                <span id="submitSpinner" class="spinner-border spinner-border-sm ms-2" style="display: none;"></span>
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    import { 
      generateResponsiveImages, 
      validateImageFile, 
      formatFileSize 
    } from '../../../lib/imageOptimizer';

    const form = document.getElementById('editForm') as HTMLFormElement;
    const imageFile = document.getElementById('imageFile') as HTMLInputElement;
    const progressSection = document.getElementById('progressSection') as HTMLElement;
    const previewGrid = document.getElementById('previewGrid') as HTMLElement;
    const uploadSection = document.getElementById('uploadSection') as HTMLElement;
    const uploadStatus = document.getElementById('uploadStatus') as HTMLElement;
    const submitBtn = document.getElementById('submitBtn') as HTMLButtonElement;
    const submitText = document.getElementById('submitText') as HTMLElement;
    const submitSpinner = document.getElementById('submitSpinner') as HTMLElement;

    let generatedImages: any = null;

    // Handle image selection
    imageFile.addEventListener('change', async (e) => {
      const target = e.target as HTMLInputElement;
      const file = target.files?.[0];
      
      if (!file) {
        generatedImages = null;
        return;
      }

      // Validate file
      const validation = validateImageFile(file);
      if (!validation.valid) {
        alert(validation.error);
        imageFile.value = '';
        generatedImages = null;
        return;
      }

      try {
        // Show progress section
        progressSection.classList.add('active');
        previewGrid.innerHTML = '';
        previewGrid.style.display = 'none';

        // Generate responsive images
        generatedImages = await generateResponsiveImages(file, (progress) => {
          const sizeKey = progress.size.split(' ')[0].toLowerCase();
          updateProgress(sizeKey, progress.progress);
        });

        // Show previews
        previewGrid.style.display = 'grid';
        for (const [size, imgFile] of Object.entries(generatedImages)) {
          const url = URL.createObjectURL(imgFile as File);
          const fileSize = formatFileSize((imgFile as File).size);
          
          const sizeLabels: Record<string, string> = {
            thumbnail: 'Thumbnail',
            small: 'Small',
            medium: 'Medium',
            large: 'Large'
          };
          
          const previewItem = document.createElement('div');
          previewItem.className = 'preview-item';
          previewItem.innerHTML = `
            <img src="${url}" alt="${size}" loading="lazy">
            <strong>${sizeLabels[size]}</strong>
            <span class="badge">${fileSize}</span>
          `;
          previewGrid.appendChild(previewItem);
        }

        progressSection.classList.remove('active');

      } catch (error: any) {
        console.error('Error:', error);
        alert('เกิดข้อผิดพลาดในการประมวลผลรูปภาพ');
        imageFile.value = '';
        generatedImages = null;
        progressSection.classList.remove('active');
      }
    });

    function updateProgress(size: string, percent: number) {
      const progressBar = document.getElementById(`progress-${size}`);
      if (progressBar) {
        progressBar.style.width = `${percent}%`;
        progressBar.textContent = `${Math.round(percent)}%`;
      }
    }

    // Date validation
    const startDate = document.getElementById('date') as HTMLInputElement;
    const endDate = document.getElementById('end_date') as HTMLInputElement;

    if (startDate && endDate) {
      startDate.addEventListener("change", () => {
        endDate.min = startDate.value;
        if (endDate.value && endDate.value < startDate.value) {
          endDate.value = "";
        }
      });
    }

    // Handle form submit
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!form.checkValidity()) {
        form.classList.add('was-validated');
        return;
      }

      try {
        // Disable submit button
        submitBtn.disabled = true;
        submitText.textContent = 'กำลังบันทึก...';
        submitSpinner.style.display = 'inline-block';

        let imageUrls = null;

        // ถ้ามีการอัปโหลดรูปใหม่
        if (generatedImages) {
          uploadSection.classList.add('active');
          uploadStatus.textContent = 'กำลังอัปโหลดรูปภาพใหม่...';

          // Generate unique event ID
          const eventId = `event-${Date.now()}`;

          // Upload images via API
          const formData = new FormData();
          formData.append('eventId', eventId);
          
          for (const [size, file] of Object.entries(generatedImages)) {
            formData.append(size, file as File);
          }

          const uploadResponse = await fetch('/api/upload-images', {
            method: 'POST',
            body: formData
          });

          if (!uploadResponse.ok) {
            const error = await uploadResponse.json();
            throw new Error(error.error || 'Upload failed');
          }

          const { urls } = await uploadResponse.json();
          imageUrls = urls;

          uploadStatus.textContent = 'กำลังบันทึกข้อมูล...';
        }

        // Prepare form data
        const formData = new FormData();
        formData.append('id', (document.querySelector('input[name="id"]') as HTMLInputElement).value);
        formData.append('title', (document.getElementById('title') as HTMLInputElement).value);
        formData.append('date', (document.getElementById('date') as HTMLInputElement).value);
        formData.append('end_date', (document.getElementById('end_date') as HTMLInputElement).value || '');
        formData.append('location', (document.getElementById('location') as HTMLInputElement).value || '');
        formData.append('link', (document.getElementById('link') as HTMLInputElement).value || '');
        formData.append('live', (document.getElementById('live') as HTMLInputElement).value || '');

        // Add image_urls if new images were uploaded
        if (imageUrls) {
          formData.append('image_urls', JSON.stringify(imageUrls));
        }

        // Submit to API
        const response = await fetch('/api/admin-event-edit', {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          const text = await response.text();
          throw new Error(text || 'เกิดข้อผิดพลาด');
        }

        // Success!
        if (uploadSection.classList.contains('active')) {
          uploadStatus.textContent = '✓ บันทึกสำเร็จ!';
        }
        submitText.textContent = '✓ บันทึกสำเร็จ!';
        
        setTimeout(() => {
          window.location.href = '/admin';
        }, 500);

      } catch (error: any) {
        console.error('Error:', error);
        alert(`เกิดข้อผิดพลาด: ${error.message}`);
        
        submitBtn.disabled = false;
        submitText.textContent = 'บันทึกการแก้ไข';
        submitSpinner.style.display = 'none';
        uploadSection.classList.remove('active');
      }
    });
  </script>
</body>
</html>