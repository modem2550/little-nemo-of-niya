---
export const prerender = false;

import { supabaseAdmin } from "../../../lib/supabaseAdmin";
import "../../../styles/main.css";
import "../../../styles/admin.css";

const { id } = Astro.params;

// ===== GET =====
const { data: event, error: fetchError } = await supabaseAdmin
  .from("event_data")
  .select("*")
  .eq("id", Number(id))
  .single();

if (fetchError || !event) {
  return new Response("Not found", { status: 404 });
}

// ===== POST =====
if (Astro.request.method === "POST") {
  const form = await Astro.request.formData();

  const date = form.get("date") || null;
  const end_date = form.get("end_date") || null;

  if (date && end_date && end_date < date) {
    return new Response("end_date ‡∏´‡πâ‡∏≤‡∏°‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ date", { status: 400 });
  }

  const payload = {
    title: form.get("title"),
    date: form.get("date") || null,
    end_date: form.get("end_date") || null,
    location: form.get("location"),
    link: form.get("link"),
    image_url: form.get("image_url"),
    live: form.get("live") || null,
  };

  const { data, error } = await supabaseAdmin
    .from("event_data")
    .update(payload)
    .eq("id", Number(id))
    .select();

  console.log(data, error);
  if (error) {
    return new Response(
      JSON.stringify(error, null, 2),
      { status: 500 }
    );
  }

  return Astro.redirect("/admin");
}
---

<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@100..900&family=Noto+Sans+Thai:wght@100..900&display=swap" rel="stylesheet">
  <title>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° - Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <div>
    <div class="create-card">
      <!-- Header -->
      <div class="header">
        <h1 class="display-2">Edit Event</h1>
      </div>

      <!-- Form Body -->
      <div class="create-body">
        <form id="editForm">
          <input type="hidden" name="id" value={event.id} />

          <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å -->
          <div class="form-section">
            <div class="section-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</div>
            
            <div class="mb-3">
              <label for="title" class="form-label required">‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</label>
              <input 
                type="text" 
                class="form-control" 
                id="title" 
                name="title" 
                value={event.title} 
                required
                placeholder="‡πÄ‡∏ä‡πà‡∏ô BNK48 Concert 2026"
              />
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="date" class="form-label required">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°</label>
                <input 
                  type="date" 
                  class="form-control" 
                  id="date" 
                  name="date" 
                  value={event.date} 
                  required
                />
              </div>
              <div class="col-md-6 mb-3">
                <label for="end_date" class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
                <input 
                  type="date" 
                  class="form-control" 
                  id="end_date" 
                  name="end_date" 
                  value={event.end_date || ''} 
                />
                <small class="helper-text">‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏ñ‡πâ‡∏≤‡∏à‡∏ö‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</small>
              </div>
            </div>
          </div>

          <!-- ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏•‡∏¥‡∏á‡∏Å‡πå -->
          <div class="form-section">
            <div class="section-title">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏•‡∏¥‡∏á‡∏Å‡πå</div>
            
            <div class="mb-3">
              <label for="location" class="form-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</label>
              <input 
                type="text" 
                class="form-control" 
                id="location" 
                name="location" 
                value={event.location || ''} 
                placeholder="‡πÄ‡∏ä‡πà‡∏ô MBK Center, Avenue A G Floor"
              />
            </div>

            <div class="mb-3">
              <label for="link" class="form-label required">‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</label>
              <input 
                type="url" 
                class="form-control" 
                id="link" 
                name="link" 
                value={event.link} 
                required
                placeholder="https://..."/>
            </div>
            <div class="mb-3">
              <label for="live" class="form-label">‡∏ä‡πà‡∏≠‡∏á‡πÑ‡∏•‡∏ü‡πå / ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
              <input 
                type="text" 
                class="form-control" 
                id="live" 
                name="live" 
                value={event.live || ''} 
                placeholder="‡πÄ‡∏ä‡πà‡∏ô YouTube Live, Facebook Live, TikTok Live"
              />
            </div>
          </div>

          <!-- ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ -->
          <div class="form-section">
            <div class="section-title">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
            
            <div class="mb-3">
              <label for="image_url" class="form-label">URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</label>
              <input 
                type="url" 
                class="form-control" 
                id="image_url" 
                name="image_url" 
                value={event.image_url || ''} 
                placeholder="https://..."
              />
              {event.image_url && (
                <div class="image-preview">
                  <img src={event.image_url} alt="Preview" />
                </div>
              )}
            </div>

            
          </div>

          <!-- Action Buttons -->
          <div class="action-buttons">
            <a href="/admin" class="btn-cancel">
              ‚Üê ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
            </a>
            <button type="submit" class="btn-submit" id="submitBtn">
              <span id="submitText">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</span>
              <span id="submitSpinner" class="spinner-border spinner-border-sm ms-2" style="display: none;"></span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    const form = document.getElementById("editForm") as HTMLFormElement;
    const submitBtn = document.getElementById("submitBtn") as HTMLButtonElement;
    const submitText = document.getElementById("submitText") as HTMLElement;
    const submitSpinner = document.getElementById("submitSpinner") as HTMLElement;

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      // Disable button
      submitBtn.disabled = true;
      submitText.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
      submitSpinner.style.display = "inline-block";

      const data = new FormData(form);

      try {
        const res = await fetch("/api/admin-event-edit", {
          method: "POST",
          body: data
        });

        if (res.ok) {
          submitText.textContent = "‚úì ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!";
          submitSpinner.style.display = "none";
          
          setTimeout(() => {
            window.location.href = "/admin";
          }, 500);
        } else {
          const text = await res.text();
          alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + text);
          
          // Re-enable button
          submitBtn.disabled = false;
          submitText.textContent = "üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç";
          submitSpinner.style.display = "none";
        }
      } catch (err) {
        console.error(err);
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢");
        
        // Re-enable button
        submitBtn.disabled = false;
        submitText.textContent = "üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç";
        submitSpinner.style.display = "none";
      }
    });

    // Date validation
    const startDate = document.getElementById('date') as HTMLInputElement;
    const endDate = document.getElementById('end_date') as HTMLInputElement;

    if (startDate && endDate) {
      startDate.addEventListener("change", () => {
        endDate.min = startDate.value;
        if (endDate.value && endDate.value < startDate.value) {
          endDate.value = "";
        }
      });
    }
  </script>
</body>
</html>